<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twitter Thread Viewer</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }
        
        body {
            background-color: #f7f9fa;
            color: #0f1419;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 10px 0;
            border-bottom: 1px solid #e6ecf0;
            margin-bottom: 20px;
        }
        
        .search-container {
            display: flex;
            gap: 10px;
        }
        
        .search-input {
            flex-grow: 1;
            padding: 8px 12px;
            border: 1px solid #e6ecf0;
            border-radius: 20px;
            font-size: 14px;
        }
        
        .search-button {
            background-color: #1da1f2;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 8px 16px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .logo {
            font-size: 20px;
            font-weight: bold;
            color: #1da1f2;
        }
        
        .thread {
            background-color: white;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        }
        
        .tweet {
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid #e6ecf0;
        }
        
        .tweet:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        
        .tweet-header {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            margin-right: 12px;
        }
        
        .user-info {
            flex-grow: 1;
        }
        
        .username {
            font-weight: bold;
            margin-bottom: 2px;
        }
        
        .handle {
            color: #657786;
            font-size: 14px;
        }
        
        .tweet-content {
            margin-bottom: 12px;
            line-height: 1.4;
        }
        
        .tweet-media {
            margin-top: 12px;
            border-radius: 16px;
            overflow: hidden;
            max-height: 400px;
        }
        
        .tweet-media img, .tweet-media video {
            width: 100%;
            height: auto;
            display: block;
        }
        
        .tweet-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 12px;
            color: #657786;
        }
        
        .action {
            display: flex;
            align-items: center;
        }
        
        .thread-line {
            width: 2px;
            background-color: #e6ecf0;
            height: 20px;
            margin-left: 24px;
            margin-bottom: 8px;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #657786;
        }
        
        .error {
            color: #e0245e;
            padding: 20px;
            text-align: center;
        }
        
        .error-message {
            color: #e0245e;
            margin-top: 5px;
            font-size: 14px;
        }
        
        .search-button:disabled {
            background-color: #8ec0e8;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">Twitter Thread Viewer</div>
            <div class="search-container">
                <input type="text" id="username-input" class="search-input" placeholder="Enter Twitter username" value="omarmhaimdat">
                <button id="search-button" class="search-button">Search</button>
            </div>
            <div id="error-message" class="error-message"></div>
        </div>
        
        <div id="threads-container">
            <div class="loading">Enter a username and click Search to load threads</div>
        </div>
    </div>

    <script>
        // Configuration
        const config = {
            limit: 50, // Number of tweets to fetch initially
            rapidapiKey: 'f1d61e4eedmsh57b9731c396c4b8p171540jsn146d8941e254',
            rapidapiHost: 'twitter154.p.rapidapi.com'
        };

        // DOM elements
        const threadsContainer = document.getElementById('threads-container');
        const searchButton = document.getElementById('search-button');
        const usernameInput = document.getElementById('username-input');
        const errorMessage = document.getElementById('error-message');

        // Initialize
        searchButton.addEventListener('click', handleSearch);
        usernameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleSearch();
        });

        async function handleSearch() {
            const username = usernameInput.value.trim();
            if (!username) {
                showError('Please enter a username');
                return;
            }
            
            // Disable button during search
            searchButton.disabled = true;
            searchButton.textContent = 'Searching...';
            errorMessage.textContent = '';
            
            try {
                await fetchUserThreads(username);
            } catch (error) {
                console.error('Search error:', error);
                showError(error.message || 'Failed to search for user');
            } finally {
                searchButton.disabled = false;
                searchButton.textContent = 'Search';
            }
        }

        function showError(message) {
            errorMessage.textContent = message;
            threadsContainer.innerHTML = `<div class="error">${message}</div>`;
        }

        // Main function to fetch user threads
        async function fetchUserThreads(username) {
            try {
                threadsContainer.innerHTML = '<div class="loading">Loading user details...</div>';
                
                // First get user details to get user_id
                const userUrl = `https://twitter154.p.rapidapi.com/user/details?username=${username}`;
                const userResponse = await makeApiCall(userUrl);
                
                if (!userResponse || !userResponse.user_id) {
                    throw new Error('User not found. Please check the username and try again.');
                }
                
                const userId = userResponse.user_id;
                
                // Now fetch user's tweets
                threadsContainer.innerHTML = '<div class="loading">Loading tweets...</div>';
                const tweetsUrl = `https://twitter154.p.rapidapi.com/user/tweets?username=${username}&limit=${config.limit}&user_id=${userId}&include_replies=true&include_pinned=false`;
                const tweetsResponse = await makeApiCall(tweetsUrl);
                
                if (!tweetsResponse || !tweetsResponse.results || tweetsResponse.results.length === 0) {
                    throw new Error('No tweets found for this user');
                }
                
                // Process tweets to find threads (tweets with replies by the same user)
                const threads = await findUserThreads(tweetsResponse.results, userId);
                
                if (threads.length === 0) {
                    threadsContainer.innerHTML = '<div class="loading">No threads found for this user</div>';
                    return;
                }
                
                // Display threads
                displayThreads(threads);
                
            } catch (error) {
                console.error('Error fetching user threads:', error);
                throw error;
            }
        }

        // Find threads where the original tweet has replies from the same user
        async function findUserThreads(tweets, userId) {
            const threads = [];
            
            for (const tweet of tweets) {
                // Only look at tweets that have replies
                if (tweet.reply_count > 0) {
                    try {
                        // Fetch all replies for this tweet
                        const repliesUrl = `https://twitter154.p.rapidapi.com/tweet/replies?tweet_id=${tweet.tweet_id}`;
                        const repliesResponse = await makeApiCall(repliesUrl);
                        
                        if (repliesResponse && repliesResponse.replies) {
                            // Filter replies to only include those from the original user
                            const userReplies = repliesResponse.replies.filter(reply => 
                                reply.user.user_id === userId
                            );
                            
                            // If there are replies from the same user, it's a thread
                            if (userReplies.length > 0) {
                                const thread = {
                                    originalTweet: tweet,
                                    replies: userReplies,
                                    hasMoreReplies: !!repliesResponse.continuation_token,
                                    continuationToken: repliesResponse.continuation_token
                                };
                                threads.push(thread);
                            }
                        }
                    } catch (error) {
                        console.error(`Error processing replies for tweet ${tweet.tweet_id}:`, error);
                    }
                }
            }
            
            return threads;
        }

        // Display threads in the UI
        function displayThreads(threads) {
            threadsContainer.innerHTML = '';
            
            threads.forEach(thread => {
                const threadDiv = document.createElement('div');
                threadDiv.className = 'thread';
                
                // Add original tweet
                threadDiv.appendChild(createTweetElement(thread.originalTweet));
                
                // Add replies
                thread.replies.forEach(reply => {
                    const threadLine = document.createElement('div');
                    threadLine.className = 'thread-line';
                    threadDiv.appendChild(threadLine);
                    
                    threadDiv.appendChild(createTweetElement(reply));
                });
                
                // Add "load more" button if there are more replies
                if (thread.hasMoreReplies) {
                    const loadMoreDiv = document.createElement('div');
                    loadMoreDiv.className = 'hidden-replies';
                    loadMoreDiv.textContent = 'Show more replies';
                    loadMoreDiv.onclick = async () => {
                        await loadMoreReplies(
                            thread.originalTweet.tweet_id, 
                            thread.continuationToken, 
                            loadMoreDiv, 
                            thread.originalTweet.user.user_id
                        );
                    };
                    threadDiv.appendChild(loadMoreDiv);
                }
                
                threadsContainer.appendChild(threadDiv);
            });
        }

        // Load more replies for a thread
        async function loadMoreReplies(tweetId, continuationToken, loadMoreDiv, userId) {
            try {
                loadMoreDiv.textContent = 'Loading...';
                
                const encodedToken = encodeURIComponent(continuationToken);
                const url = `https://twitter154.p.rapidapi.com/tweet/replies/continuation?tweet_id=${tweetId}&continuation_token=${encodedToken}`;
                
                const response = await makeApiCall(url);
                
                if (response && response.replies) {
                    // Filter to only include replies from the original user
                    const userReplies = response.replies.filter(reply => 
                        reply.user.user_id === userId
                    );
                    
                    if (userReplies.length > 0) {
                        // Create elements for the new replies
                        const fragment = document.createDocumentFragment();
                        userReplies.forEach(reply => {
                            const threadLine = document.createElement('div');
                            threadLine.className = 'thread-line';
                            fragment.appendChild(threadLine);
                            
                            fragment.appendChild(createTweetElement(reply));
                        });
                        
                        // Insert before the load more button
                        loadMoreDiv.parentNode.insertBefore(fragment, loadMoreDiv);
                    }
                    
                    // Update or remove the load more button
                    if (response.continuation_token) {
                        loadMoreDiv.textContent = 'Show more replies';
                        loadMoreDiv.onclick = async () => {
                            await loadMoreReplies(
                                tweetId, 
                                response.continuation_token, 
                                loadMoreDiv,
                                userId
                            );
                        };
                    } else {
                        loadMoreDiv.remove();
                    }
                }
            } catch (error) {
                console.error('Error loading more replies:', error);
                loadMoreDiv.textContent = 'Error loading more replies';
                loadMoreDiv.style.color = '#e0245e';
            }
        }

        // Create a tweet element
        function createTweetElement(tweet) {
            const tweetDiv = document.createElement('div');
            tweetDiv.className = 'tweet';
            
            // Tweet header with user info
            const tweetHeader = document.createElement('div');
            tweetHeader.className = 'tweet-header';
            
            const avatarImg = document.createElement('img');
            avatarImg.className = 'avatar';
            avatarImg.src = tweet.user.profile_pic_url || 'https://abs.twimg.com/sticky/default_profile_images/default_profile_normal.png';
            avatarImg.alt = `${tweet.user.name}'s avatar`;
            
            const userInfoDiv = document.createElement('div');
            userInfoDiv.className = 'user-info';
            
            const usernameSpan = document.createElement('span');
            usernameSpan.className = 'username';
            usernameSpan.textContent = tweet.user.name;
            
            const handleSpan = document.createElement('span');
            handleSpan.className = 'handle';
            handleSpan.textContent = `@${tweet.user.username}`;
            
            userInfoDiv.appendChild(usernameSpan);
            userInfoDiv.appendChild(document.createElement('br'));
            userInfoDiv.appendChild(handleSpan);
            
            tweetHeader.appendChild(avatarImg);
            tweetHeader.appendChild(userInfoDiv);
            
            // Tweet content
            const contentDiv = document.createElement('div');
            contentDiv.className = 'tweet-content';
            contentDiv.textContent = tweet.text;
            
            // Tweet media (if any)
            let mediaDiv = null;
            if (tweet.media && tweet.media.length > 0) {
                mediaDiv = document.createElement('div');
                mediaDiv.className = 'tweet-media';
                
                tweet.media.forEach(mediaItem => {
                    if (mediaItem.type === 'photo') {
                        const img = document.createElement('img');
                        img.src = mediaItem.url;
                        img.alt = 'Tweet media';
                        mediaDiv.appendChild(img);
                    } else if (mediaItem.type === 'video') {
                        const video = document.createElement('video');
                        video.controls = true;
                        video.src = mediaItem.url;
                        mediaDiv.appendChild(video);
                    }
                });
            }
            
            // Tweet actions
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'tweet-actions';
            
            const replyAction = createAction('Reply', tweet.reply_count);
            const retweetAction = createAction('Retweet', tweet.retweet_count);
            const likeAction = createAction('Like', tweet.favorite_count);
            
            actionsDiv.appendChild(replyAction);
            actionsDiv.appendChild(retweetAction);
            actionsDiv.appendChild(likeAction);
            
            // Assemble the tweet
            tweetDiv.appendChild(tweetHeader);
            tweetDiv.appendChild(contentDiv);
            if (mediaDiv) {
                tweetDiv.appendChild(mediaDiv);
            }
            tweetDiv.appendChild(actionsDiv);
            
            return tweetDiv;
        }

        // Create an action button (reply, retweet, like)
        function createAction(label, count) {
            const actionDiv = document.createElement('div');
            actionDiv.className = 'action';
            
            // Simple icon placeholder (in a real app, you'd use SVG icons)
            const icon = document.createElement('span');
            icon.textContent = label[0];
            
            const countSpan = document.createElement('span');
            countSpan.textContent = count || '';
            
            actionDiv.appendChild(icon);
            actionDiv.appendChild(countSpan);
            
            return actionDiv;
        }

        // Generic API call function
        async function makeApiCall(url) {
            try {
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'x-rapidapi-host': config.rapidapiHost,
                        'x-rapidapi-key': config.rapidapiKey
                    }
                });
                
                if (!response.ok) {
                    // Try to get error message from response
                    const errorData = await response.json().catch(() => ({}));
                    const errorMsg = errorData.message || `API request failed with status ${response.status}`;
                    throw new Error(errorMsg);
                }
                
                return await response.json();
            } catch (error) {
                console.error('API call error:', error);
                throw error;
            }
        }
    </script>
</body>
</html>